{"ts":1372338858850,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"//url: \r\n//file:///E:/peer/WebRTCGame/index.htm?i=main&mode=host&guid=de8d49b78a85a322c4155015fdce22c4&username=testusername\r\n//mode=host or mode=client\r\n//guid=xxxxxxx\r\n//var key = 'lz6yk6yy4tg74x6r';\r\nvar key = 'kmjpk4hdea5rk9';\r\n\r\nvar Game = {};\r\n\r\nwindow.requestAnimFrame = (function() {\r\n  'use strict';\r\n  return window.requestAnimationFrame ||\r\n    window.webkitRequestAnimationFrame ||\r\n    window.mozRequestAnimationFrame ||\r\n    window.oRequestAnimationFrame ||\r\n    window.msRequestAnimationFrame || function(callback) {\r\n    window.setTimeout(callback, 1000 / 30);\r\n  };\r\n})();\r\n\r\nvar urlParams;\r\n(window.onpopstate = function() {\r\n  var match,\r\n    pl = /\\+/g, // Regex for replacing addition symbol with a space\r\n    search = /([^&=]+)=?([^&]*)/g,\r\n    decode = function(s) {\r\n      return decodeURIComponent(s.replace(pl, \" \"));\r\n    },\r\n    query = window.location.search.substring(1);\r\n\r\n  urlParams = {};\r\n  while (match = search.exec(query))\r\n    urlParams[decode(match[1])] = decode(match[2]);\r\n})();\r\n\r\nconsole.log(JSON.stringify(urlParams));\r\n\r\nGame.Ball = function Ball() {\r\n  this.pos = {\r\n    x: 640 / 2,\r\n    y: 480 / 2\r\n  };\r\n  this.radius = 10;\r\n  this.vx = 0;\r\n  this.vy = 0;\r\n  this.rotation = 0;\r\n  this.scale = {\r\n    x: 1,\r\n    y: 1\r\n  };\r\n  this.color = 'red'; //utils.parseColor(color);\r\n  this.lineWidth = 1;\r\n  this.lastPos = {\r\n    x: 640 / 2,\r\n    y: 480 / 2\r\n  };\r\n  this.speed = 3;\r\n  this.velocity = {\r\n    x: Math.random() * 10 - 5,\r\n    y: Math.random() * 10 - 5\r\n  };\r\n};\r\nGame.Ball.prototype.draw = function draw(context) {\r\n  context.save();\r\n  context.translate(this.pos.x, this.pos.y);\r\n  context.rotate(this.rotation);\r\n  context.scale(this.scale.x, this.scale.y);\r\n\r\n  context.lineWidth = this.lineWidth;\r\n  context.fillStyle = this.color;\r\n  context.beginPath();\r\n  context.arc(0, 0, this.radius, 0, (Math.PI * 2), true);\r\n  context.closePath();\r\n  context.fill();\r\n  if (this.lineWidth > 0) {\r\n    context.stroke();\r\n  }\r\n  context.restore();\r\n};\r\nGame.Ball.prototype.reset = function reset() {\r\n  this.pos = {\r\n    x: 640 / 2,\r\n    y: 480 / 2\r\n  };\r\n  this.velocity = {\r\n    x: Math.random() * 10 - 5,\r\n    y: Math.random() * 10 - 5\r\n  };\r\n};\r\n\r\n\r\nball = new Game.Ball();\r\n\r\n//Game.draw = function() {};\r\n\r\nvar canvas;\r\nvar ctx;\r\nvar ballSpeed = 3;\r\nvar paddle0Pos = 480 / 2;\r\nvar paddle0Posx = 20;\r\nvar paddle1Pos = 480 / 2;\r\nvar paddle1Posx = 640 - 30;\r\nvar lastPaddle0Pos = 480 / 2;\r\nvar lastPaddle1Pos = 480 / 2;\r\n\r\nvar lastBallPos = {\r\n  x: 640 / 2,\r\n  y: 480 / 2\r\n};\r\nvar paddleHeight = 100;\r\nvar paddleWidth = 10;\r\nvar ballWidth = 10;\r\n\r\n\r\nvar player0Score = 0;\r\nvar player1Score = 0;\r\nvar score = player0Score + \"   :   \" + player1Score;\r\n\r\n\r\nvar renderPong = function() {\r\n  ctx.fillStyle = 'white';\r\n  ctx.fillRect(0, 0, 640, 480);\r\n  ctx.fillStyle = 'red';\r\n  ctx.fillRect(20, paddle0Pos - paddleHeight / 2, paddleWidth, paddleHeight);\r\n\r\n  ctx.fillStyle = 'blue';\r\n  ctx.fillRect(640 - 30, paddle1Pos - paddleHeight / 2, paddleWidth, paddleHeight);\r\n\r\n  //ctx.fillStyle = 'green';\r\n  //ctx.fillRect(ballPos.x - ballWidth / 2, ballPos.y - ballWidth / 2, ballWidth, ballWidth);\r\n\r\n  ball.draw(ctx);\r\n\r\n  ctx.fillStyle = \"blue\";\r\n  ctx.fillText(score, 640 / 2 - 50, 20);\r\n};\r\n\r\n\r\n\r\nvar startServer = function() {\r\n  console.log(\"startServer\");\r\n  console.log(\"Mode: \" + urlParams.mode);\r\n  console.log(\"GUID: \" + urlParams.guid);\r\n  Object.defineProperty(this, \"ballPos\", {\r\n    get: function() {\r\n      return ball.pos;\r\n    },\r\n    set: function(value) {\r\n      if (value !== ball.pos) {\r\n        app.send({\r\n          type: \"ballPos\",\r\n          pos: ballPos\r\n        });\r\n        ball.pos = value;\r\n      }\r\n    },\r\n    enumerable: true,\r\n    configurable: true\r\n  });\r\n\r\n  var run = function() {\r\n    renderPong();\r\n    if (Key.isDown(Key.DOWN_ARROW)) {\r\n      paddle0Pos += 2;\r\n    }\r\n    if (Key.isDown(Key.UP_ARROW)) {\r\n      paddle0Pos -= 2;\r\n    }\r\n    paddle0Pos = Math.max(paddle0Pos, 0);\r\n    paddle0Pos = Math.min(paddle0Pos, 640);\r\n\r\n    ballPos = {\r\n      x: ball.pos.x += ball.velocity.x,\r\n      y: ball.pos.y += ball.velocity.y\r\n    };\r\n\r\n    if (ballPos.x > 640 || ballPos.x < 0) {\r\n      if (ballPos.x < 0) {\r\n        player1Score++;\r\n      }\r\n      if (ballPos.x > 640) {\r\n        player0Score++;\r\n      }\r\n      score = player0Score + \"   :   \" + player1Score;\r\n      app.send({\r\n        type: \"score\",\r\n        score: score\r\n      });\r\n\r\n      ball.reset();\r\n    }\r\n    var paddle0right = paddle0Posx + paddleWidth / 2;\r\n    var paddle0top = paddle0Pos - paddleHeight / 2;\r\n    var paddle0Bottom = paddle0Pos + paddleHeight / 2;\r\n    var paddle0left = paddle0Posx - paddleWidth / 2;\r\n\r\n    var paddle1right = paddle1Posx + paddleWidth / 2;\r\n    var paddle1top = paddle1Pos - paddleHeight / 2;\r\n    var paddle1Bottom = paddle1Pos + paddleHeight / 2;\r\n    var paddle1left = paddle1Posx - paddleWidth / 2;\r\n\r\n    var ballleft = ball.pos.x - ball.radius;\r\n    var ballright = ball.pos.x + ball.radius;\r\n    var balltop = ball.pos.y - ball.radius;\r\n    var ballbottom = ball.pos.y + ball.radius;\r\n\r\n\r\n\r\n    if (ballleft <= paddle0right) {\r\n\r\n      if (ballbottom >= paddle0top && balltop <= paddle0Bottom) {\r\n        if (ballleft > paddle0left) {\r\n          ball.velocity.x *= -1;\r\n        }\r\n\r\n      }\r\n    }\r\n    if (ballright >= paddle1left) {\r\n      if (ballbottom >= paddle1top && balltop <= paddle1Bottom) {\r\n        if (ballright < paddle1right) {\r\n          ball.velocity.x *= -1;\r\n        }\r\n      }\r\n    }\r\n\r\n\r\n    if (ball.pos.y > 480 - ball.radius || ball.pos.y < 0 + ball.radius) {\r\n      ball.velocity.y *= -1;\r\n    }\r\n\r\n    if (paddle0Pos != lastPaddle0Pos) {\r\n      lastPaddle0Pos = paddle0Pos;\r\n      app.send({\r\n        type: \"paddle0Pos\",\r\n        pos: paddle0Pos\r\n      });\r\n    }\r\n\r\n\r\n    window.requestAnimFrame(run);\r\n  };\r\n  var app;\r\n  if (urlParams.mode === \"host\") {\r\n    if (urlParams.guid !== undefined){\r\n      app = new App(key, urlParams.guid);\r\n    } else {\r\n      app = new App(key);\r\n    }\r\n    \r\n  } else {\r\n    app = new App(key);\r\n  }\r\n\r\n  app.on(\"connected\", function() {\r\n    console.log(\"connected with peer\");\r\n    canvas = document.createElement('canvas');\r\n\r\n    canvas.width = 640;\r\n    canvas.height = 480;\r\n    ctx = canvas.getContext('2d');\r\n    $(document.body).append(canvas);\r\n    // document.getElementsByTagName('body')[0].appendChild('canvas');\r\n    window.requestAnimFrame(run);\r\n  });\r\n  app.on(\"disconnected\", function() {\r\n    console.log(\"disconnected with peer\");\r\n    $('.headerBar').fadeIn();\r\n  });\r\n  app.on(\"message\", function(obj) {\r\n    if (obj.type == \"paddle1Pos\") {\r\n      paddle1Pos = obj.pos;\r\n    }\r\n  });\r\n  app.on(\"error\", function(err) {\r\n    console.log(err);\r\n  });\r\n  app.host();\r\n  if (urlParams.guid === undefined) {\r\n    window.prompt(\"Give this code to the other person\", app.guid);\r\n  }\r\n\r\n  $('.headerBar').fadeOut();\r\n};\r\n\r\nvar startClient = function() {\r\n  console.log(\"start client\");\r\n  console.log(\"Mode: \" + urlParams.mode);\r\n  console.log(\"GUID: \" + urlParams.guid);\r\n  var run = function() {\r\n    renderPong();\r\n    if (Key.isDown(Key.DOWN_ARROW)) {\r\n      paddle1Pos += 2;\r\n    }\r\n    if (Key.isDown(Key.UP_ARROW)) {\r\n      paddle1Pos -= 2;\r\n    }\r\n    paddle1Pos = Math.max(paddle1Pos, 0);\r\n    paddle1Pos = Math.min(paddle1Pos, 640);\r\n\r\n    if (paddle1Pos != lastPaddle1Pos) {\r\n      lastPaddle1Pos = paddle1Pos;\r\n      app.send({\r\n        type: \"paddle1Pos\",\r\n        pos: paddle1Pos\r\n      });\r\n    }\r\n    window.requestAnimFrame(run);\r\n  };\r\n\r\n  var app;\r\n  if (urlParams.mode === \"client\") {\r\n\r\n    if (urlParams.guid !== undefined) {\r\n      console.log(\"1Mode: \" + urlParams.mode);\r\n      console.log(\"1GUID: \" + urlParams.guid);\r\n      app = new App(key, urlParams.guid);\r\n    } else {\r\n      app = new App(key);\r\n    }\r\n  } else {\r\n    app = new App(key);\r\n  }\r\n  if (app === undefined) {\r\n    app = new App(key);\r\n  }\r\n  //var app = new App(key);\r\n  app.on(\"connected\", function() {\r\n    canvas = document.createElement('canvas');\r\n    canvas.width = 640;\r\n    canvas.height = 480;\r\n    ctx = canvas.getContext('2d');\r\n    $(document.body).append(canvas);\r\n    console.log(\"connected with peer\");\r\n\r\n    window.requestAnimFrame(run);\r\n  });\r\n  app.on(\"disconnected\", function() {\r\n    console.log(\"disconnected with peer\");\r\n    $('.headerBar').fadeIn();\r\n  });\r\n  app.on(\"message\", function(obj) {\r\n    if (obj.type == \"paddle0Pos\") {\r\n      paddle0Pos = obj.pos;\r\n    }\r\n    if (obj.type == \"ballPos\") {\r\n      ball.pos = obj.pos;\r\n    }\r\n    if (obj.type == \"score\") {\r\n      score = obj.score;\r\n    }\r\n  });\r\n  app.on(\"error\", function(err) {\r\n    console.log(err);\r\n  });\r\n  if (urlParams.guid === undefined) {\r\n    app.join(window.prompt(\"Enter in game code\"));\r\n  } else {\r\n    app.join(urlParams.guid);\r\n  }\r\n\r\n  $('.headerBar').fadeOut();\r\n};\r\n\r\ndocument.addEventListener('DOMContentLoaded', function() {\r\n  'use strict';\r\n\r\n  console.log(\"loaded\");\r\n  if (urlParams.mode === \"host\") {\r\n    startServer();\r\n  } else {\r\n    if (urlParams.mode === \"client\") {\r\n      startClient();\r\n    }\r\n  }\r\n\r\n});"]],"start1":0,"start2":0,"length1":0,"length2":9092}]],"length":9092}
{"contributors":[],"silentsave":false,"ts":1372340303584,"patch":[[{"diffs":[[0,"username"],[1,"&lobbyDocURL=xxx"],[0,"\r\n//mode"]],"start1":116,"start2":116,"length1":16,"length2":32},{"diffs":[[0,"5rk9';\r\n"],[1,"var lobbyDocURL = \"\";"],[0,"\r\nvar Ga"]],"start1":240,"start2":240,"length1":16,"length2":37},{"diffs":[[0,"rict';\r\n"],[1,"    lobbyDocURL = urlParams.lobbyDocURL;\r\n    "],[0,"\r\n  cons"]],"start1":8946,"start2":8946,"length1":16,"length2":62}]],"length":9175,"saved":false}
{"ts":1372341440681,"patch":[[{"diffs":[[0,"ocURL;\r\n    "],[1,"var socket = io.connect(lobbyDocURL);\r\n     socket.emit(\"join\", nick, function(successful, users) {\r\n         if (successful){\r\n             \r\n         }\r\n     });"],[0,"\r\n  console."]],"start1":8988,"start2":8988,"length1":24,"length2":187}]],"length":9338,"saved":false}
{"ts":1372341604478,"patch":[[{"diffs":[[0,"n\", "],[-1,"nick"],[1,"urlParams.username+ \"-\"+urlParams.mode"],[0,", fu"]],"start1":9060,"start2":9060,"length1":12,"length2":46},{"diffs":[[0,"            "],[1,"alert(urlParams.username+ \"-\"+urlParams.mode);"],[0,"\r\n         }"]],"start1":9163,"start2":9163,"length1":24,"length2":70}]],"length":9418,"saved":false}
